AWSTemplateFormatVersion: "2010-09-09"
Description: Digital Identity IPV CRI KBV HMRC API
Transform: [AWS::LanguageExtensions, AWS::Serverless-2016-10-31]
Metadata:
  cfn-lint:
    config:
      ignore_checks:
        - W2031
        - W1020

Parameters:
  VpcStackName:
    Description: >
      The name of the stack that defines the VPC in which this container will
      run.
    Type: String
    Default: "cri-vpc"
  CodeSigningConfigArn:
    Type: String
    Default: ""
  PermissionsBoundary:
    Type: String
    Default: ""
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, build, staging, integration, production]
  AuditEventNamePrefix:
    Description: "The audit event name prefix"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/common-cri-parameters/AuditEventNamePrefix"
  CriIdentifier:
    Description: "The unique credential issuer identifier"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/common-cri-parameters/CriIdentifier"
  CommonStackName:
    Type: String
    Default: common-cri-api
    Description: The name of the stack containing the common CRI lambdas/infra
  ParameterPrefix:
    Type: String
    Default: "none"
    Description: If set the this value will be used for ParameterStore prefix instead of AWS::StackName
  DeploymentType:
    Type: String
    Default: "pipeline"
    Description: Private Api gateway resources are not be reachable in stacks deployed via pipelines, this override enables less restrictive settings for manual/pre-merge-test deployments.
  UseApiKey:
    Type: String
    Default: "true"
    Description: Value used to indicate if the public api should be protected by an api key.
  TxmaStackName:
    Description: "The stack containing the TXMA infrastructure"
    Type: String
    Default: txma-infrastructure
  LogGroupRetentionInDays:
    Description: "Retention for all log groups"
    Type: Number
    Default: "7"

Conditions:
  # Avoid adding a standalone IsDevEnv condition
  # As "dev" covers multiple configurations - pipeline, manual, pre-merge and preview
  IsDeployedFromPipeline:
    Fn::Equals:
      - !Ref DeploymentType
      - "pipeline"
  # Don't send logs in dev to avoid overwhelming the destination with debug
  LogSendingEnabled: !And
    - !Not [!Equals [!Ref Environment, "dev"]]
    - !Condition IsDeployedFromPipeline
  EnforceCodeSigning: !Not [!Equals [!Ref CodeSigningConfigArn, ""]]
  UsePermissionsBoundary: !Not [!Equals [!Ref PermissionsBoundary, ""]]
  UseParameterPrefix:
    Fn::Not:
      - Fn::Equals:
          - !Ref ParameterPrefix
          - "none"
  IsProdEnvironment:
    Fn::Equals:
      - !Ref Environment
      - production

Globals:
  Function:
    Timeout: 30
    CodeUri: ..
    Runtime: nodejs18.x
    Architectures: [arm64]
    MemorySize: 256
    PermissionsBoundary:
      !If [UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue]
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps
        AWS_STACK_NAME: !Sub ${AWS::StackName}
        POWERTOOLS_LOG_LEVEL: INFO
        SQS_AUDIT_EVENT_QUEUE_URL: !ImportValue AuditEventQueueUrl
        SQS_AUDIT_EVENT_PREFIX: !Ref AuditEventNamePrefix
        POWERTOOLS_METRICS_NAMESPACE: !Ref CriIdentifier
        PARAMETER_PREFIX:
          !If [UseParameterPrefix, !Ref ParameterPrefix, !Ref AWS::StackName]
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: true
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
        DT_CONNECTION_BASE_URL: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
        DT_CLUSTER_ID: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
        DT_TENANT: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}"
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn,
              ]
    Layers:
      - !Sub
        - "{{resolve:secretsmanager:${SecretArn}:SecretString:JAVA_LAYER}}" # or NODEJS_LAYER or PYTHON_LAYER
        - SecretArn:
            !FindInMap [
              EnvironmentConfiguration,
              !Ref Environment,
              dynatraceSecretArn,
            ]

Mappings:
  EnvironmentConfiguration:
    dev:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      VerifiableCredentialMaxJwtTtl: 2
      VerifiableCredentialJwtTtlUnit: HOURS
      StateMachineLoggingIncludeExecutionData: true
      StateMachineLoggingLevel: "ALL"
      apiKeythrottleQuotaLimit: 1
      apiKeythrottleRateLimit: 1
      apiKeythrottleBurstLimit: 1
      apiGatewayMethodThrottlingRateLimit: 1
      apiGatewayMethodThrottlingBurstLimit: 1
    build:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      VerifiableCredentialMaxJwtTtl: 2
      VerifiableCredentialJwtTtlUnit: HOURS
      StateMachineLoggingIncludeExecutionData: true
      StateMachineLoggingLevel: "ALL"
      apiKeythrottleQuotaLimit: 1
      apiKeythrottleRateLimit: 1
      apiKeythrottleBurstLimit: 1
      apiGatewayMethodThrottlingRateLimit: 1
      apiGatewayMethodThrottlingBurstLimit: 1
    staging:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      VerifiableCredentialMaxJwtTtl: 6
      VerifiableCredentialJwtTtlUnit: MONTHS
      StateMachineLoggingIncludeExecutionData: true
      StateMachineLoggingLevel: "ALL"
      apiKeythrottleQuotaLimit: 1
      apiKeythrottleRateLimit: 1
      apiKeythrottleBurstLimit: 1
      apiGatewayMethodThrottlingRateLimit: 1
      apiGatewayMethodThrottlingBurstLimit: 1
    integration:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      VerifiableCredentialMaxJwtTtl: 6
      VerifiableCredentialJwtTtlUnit: MONTHS
      StateMachineLoggingIncludeExecutionData: false # PII in state data
      StateMachineLoggingLevel: "ALL"
      apiKeythrottleQuotaLimit: 1
      apiKeythrottleRateLimit: 1
      apiKeythrottleBurstLimit: 1
      apiGatewayMethodThrottlingRateLimit: 1
      apiGatewayMethodThrottlingBurstLimit: 1
    production:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables
      VerifiableCredentialMaxJwtTtl: 6
      VerifiableCredentialJwtTtlUnit: MONTHS
      StateMachineLoggingIncludeExecutionData: false # PII in state data
      StateMachineLoggingLevel: "ALL"
      apiKeythrottleQuotaLimit: 1
      apiKeythrottleRateLimit: 1
      apiKeythrottleBurstLimit: 1
      apiGatewayMethodThrottlingRateLimit: 1
      apiGatewayMethodThrottlingBurstLimit: 1

Resources:
  ####################################################################
  #                                                                  #
  # API Gateway                                                      #
  #                                                                  #
  ####################################################################

  PublicKbvHmrcApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "${AWS::StackName}-PublicKbvHmrcApi"
      Description: Public KBV HMRC CRI API
      StageName: !Ref Environment
      Auth:
        ApiKeyRequired: !Ref UseApiKey
      MethodSettings:
        - LoggingLevel: INFO
          ResourcePath: "/*"
          HttpMethod: "*"
          # Disable data trace in production to avoid logging customer sensitive information
          DataTraceEnabled: !If [IsProdEnvironment, false, true]
          MetricsEnabled: true
          ThrottlingRateLimit:
            !FindInMap [
              EnvironmentConfiguration,
              !Ref Environment,
              apiGatewayMethodThrottlingRateLimit,
            ]
          ThrottlingBurstLimit:
            !FindInMap [
              EnvironmentConfiguration,
              !Ref Environment,
              apiGatewayMethodThrottlingBurstLimit,
            ]
      AccessLogSetting:
        DestinationArn: !GetAtt PublicKbvHmrcApiAccessLogGroup.Arn
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip":"$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path":"$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLatency":"$context.responseLatency",
          "responseLength":"$context.responseLength"
          }
      TracingEnabled: true
      DefinitionBody:
        openapi: 3.0.1
        paths: # workaround to get `sam validate` to work
          /never-created:
            options: {}
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: "./public-api.yaml"
          securitySchemes: !If
            - IsDeployedFromPipeline
            - api_key:
                type: "apiKey"
                name: "x-api-key"
                in: "header"
            - !Ref "AWS::NoValue"
      OpenApiVersion: 3.0.1
      EndpointConfiguration:
        Type: REGIONAL

  PublicKbvHmrcApiAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/apigateway/${AWS::StackName}-public-AccessLogs
      RetentionInDays: !Ref LogGroupRetentionInDays
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  PublicKbvHmrcApiAccessLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref PublicKbvHmrcApiAccessLogGroup

  PrivateKbvHmrcApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "${AWS::StackName}-PrivateKbvHmrcApi"
      Description: Private KBV HMRC CRI API
      StageName: !Ref Environment
      MethodSettings:
        - LoggingLevel: INFO
          ResourcePath: "/*"
          HttpMethod: "*"
          # Disable data trace in production to avoid logging customer sensitive information
          DataTraceEnabled: !If [IsProdEnvironment, false, true]
          MetricsEnabled: true
          ThrottlingRateLimit:
            !FindInMap [
              EnvironmentConfiguration,
              !Ref Environment,
              apiGatewayMethodThrottlingRateLimit,
            ]
          ThrottlingBurstLimit:
            !FindInMap [
              EnvironmentConfiguration,
              !Ref Environment,
              apiGatewayMethodThrottlingBurstLimit,
            ]
      AccessLogSetting:
        DestinationArn: !GetAtt PrivateKbvHmrcApiAccessLogGroup.Arn
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip":"$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path":"$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLatency":"$context.responseLatency",
          "responseLength":"$context.responseLength"
          }
      TracingEnabled: true
      DefinitionBody:
        openapi: "3.0.1" # workaround to get `sam validate` to work
        paths: # workaround to get `sam validate` to work
          /never-created:
            options: {} # workaround to get `sam validate` to work
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: "./private-api.yaml"
      OpenApiVersion: 3.0.1
      EndpointConfiguration:
        Type: !If [IsDeployedFromPipeline, PRIVATE, REGIONAL]
      Auth:
        ResourcePolicy:
          CustomStatements:
            - Action: "execute-api:Invoke"
              Effect: Allow
              Principal: "*"
              Resource:
                - "execute-api:/*"
            - !If
              - IsDeployedFromPipeline
              - Action: "execute-api:Invoke"
                Effect: Deny
                Principal: "*"
                Resource:
                  - "execute-api:/*"
                Condition:
                  StringNotEquals:
                    aws:SourceVpce:
                      - Fn::ImportValue: !Sub "${VpcStackName}-ExecuteApiGatewayEndpointId"
              - !Ref AWS::NoValue

  PrivateKbvHmrcApiAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/apigateway/${AWS::StackName}-private-AccessLogs
      RetentionInDays: !Ref LogGroupRetentionInDays
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  PrivateKbvHmrcApiAccessLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref PrivateKbvHmrcApiAccessLogGroup

  ExecuteStateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      Description: Role to allow API gateway to execute step functions
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service: apigateway.amazonaws.com
      Policies:
        - PolicyName: AllowStateMachineInvoke
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource: "*"
                Action:
                  - states:StartExecution
                  - states:StartSyncExecution
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  ####################################################################
  #                                                                  #
  # FetchQuestionsStateMachine                                       #
  #                                                                  #
  ####################################################################

  FetchQuestionsStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Name: !Sub ${AWS::StackName}-FetchQuestionsStateMachine
      DefinitionUri: ../step-functions/fetch-questions.asl.json
      DefinitionSubstitutions:
        OtgApiUrl: !If
          - UseParameterPrefix
          - !Sub "/${ParameterPrefix}/OtgApiUrl"
          - !Sub "/${AWS::StackName}/OtgApiUrl"
        QuestionsTableName: !Ref QuestionsTable
        QuestionsUrl: !If
          - UseParameterPrefix
          - !Sub "/${ParameterPrefix}/QuestionsUrl"
          - !Sub "/${AWS::StackName}/QuestionsUrl"
        UserAgent: !If
          - UseParameterPrefix
          - !Sub "/${ParameterPrefix}/UserAgent"
          - !Sub "/${AWS::StackName}/UserAgent"
        Issuer: !Sub "/${CommonStackName}/verifiable-credential/issuer"
        SSMParametersFunctionArn: !GetAtt SSMParametersFunction.Arn
        OTGTokenFunctionArn: !GetAtt OTGTokenFunction.Arn
        DynamoUnmarshallArn: !GetAtt DynamoUnmarshallFunction.Arn
        FetchQuestionsArn: !GetAtt FetchQuestionsFunction.Arn
        SessionTableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        PersonIdentityTableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt FetchQuestionsStateMachineLogGroup.Arn
        IncludeExecutionData:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            StateMachineLoggingIncludeExecutionData,
          ]
        Level:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            StateMachineLoggingLevel,
          ]
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTable
        - LambdaInvokePolicy:
            FunctionName: !Ref SSMParametersFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref DynamoUnmarshallFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref OTGTokenFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref FetchQuestionsFunction
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  FetchQuestionsStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/${AWS::StackName}-FetchQuestionsStateMachine-logs
      RetentionInDays: !Ref LogGroupRetentionInDays

  FetchQuestionsStateMachineLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref FetchQuestionsStateMachineLogGroup

  ####################################################################
  #                                                                  #
  # GetQuestionStateMachine                                          #
  #                                                                  #
  ####################################################################

  GetQuestionStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Name: !Sub ${AWS::StackName}-GetQuestion
      DefinitionUri: ../step-functions/get-question.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt GetQuestionStateMachineLogGroup.Arn
        IncludeExecutionData:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            StateMachineLoggingIncludeExecutionData,
          ]
        Level:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            StateMachineLoggingLevel,
          ]
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTable
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      DefinitionSubstitutions:
        PersonIdentityTableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        QuestionsTableName: !Ref QuestionsTable

  GetQuestionStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/${AWS::StackName}-GetQuestion-state-machine-logs
      RetentionInDays: !Ref LogGroupRetentionInDays

  GetQuestionStateMachineLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref GetQuestionStateMachineLogGroup

  ####################################################################
  #                                                                  #
  # PostAnswerStateMachine                                           #
  #                                                                  #
  ####################################################################

  PostAnswerStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Name: !Sub ${AWS::StackName}-PostAnswer
      DefinitionUri: ../step-functions/post-answer.asl.json
      DefinitionSubstitutions:
        OtgApiUrl: !If
          - UseParameterPrefix
          - !Sub "/${ParameterPrefix}/OtgApiUrl"
          - !Sub "/${AWS::StackName}/OtgApiUrl"
        AnswersUrl: !If
          - UseParameterPrefix
          - !Sub "/${ParameterPrefix}/AnswersUrl"
          - !Sub "/${AWS::StackName}/AnswersUrl"
        UserAgent: !If
          - UseParameterPrefix
          - !Sub "/${ParameterPrefix}/UserAgent"
          - !Sub "/${AWS::StackName}/UserAgent"
        Issuer: !Sub "/${CommonStackName}/verifiable-credential/issuer"
        DynamoUnmarshallArn: !GetAtt DynamoUnmarshallFunction.Arn
        SSMParametersFunctionArn: !GetAtt SSMParametersFunction.Arn
        OTGTokenFunctionArn: !GetAtt OTGTokenFunction.Arn
        AnswerValidationArn: !GetAtt AnswerValidationFunction.Arn
        SubmitAnswersArn: !GetAtt SubmitAnswerFunction.Arn
        CreateAuthCodeFunctionArn: !GetAtt CreateAuthCodeFunction.Arn
        SessionTableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        PersonIdentityTableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        AnswersTableName: !Ref AnswersTable
        QuestionsTableName: !Ref QuestionsTable
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt PostAnswerStateMachineLogGroup.Arn
        IncludeExecutionData:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            StateMachineLoggingIncludeExecutionData,
          ]
        Level:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            StateMachineLoggingLevel,
          ]
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref DynamoUnmarshallFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref SSMParametersFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref OTGTokenFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref AnswerValidationFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref SubmitAnswerFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref CreateAuthCodeFunction
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref AnswersTable
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBWritePolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTable
        - DynamoDBWritePolicy:
            TableName: !Ref AnswersTable
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  PostAnswerStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/${AWS::StackName}-PostAnswer-state-machine-logs
      RetentionInDays: !Ref LogGroupRetentionInDays

  PostAnswerStateMachineLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref PostAnswerStateMachineLogGroup

  ####################################################################
  #                                                                  #
  # IssueCredentialStateMachine                                      #
  #                                                                  #
  ####################################################################

  IssueCredentialStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Name: !Sub ${AWS::StackName}-IssueCredential
      DefinitionUri: ../step-functions/issue-credential.asl.json
      DefinitionSubstitutions:
        QuestionsTableName: !Ref QuestionsTable
        SessionTableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        PersonIdentityTableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        CommonStackName: !Ref CommonStackName
        SSMParametersFunctionArn: !GetAtt SSMParametersFunction.Arn
        DynamoUnmarshallArn: !GetAtt DynamoUnmarshallFunction.Arn
        IssueCredentialArn: !GetAtt IssueCredentialFunction.Arn
        JwtSignerFunction: !GetAtt JwtSignerFunction.Arn
        MaxJwtTtl: !Sub "/${AWS::StackName}/MaxJwtTtl"
        JwtTtlUnit: !Sub "/${AWS::StackName}/JwtTtlUnit"
        Issuer: !Sub "/${CommonStackName}/verifiable-credential/issuer"
        VerifiableCredentialKmsSigningKeyId: !Sub "/${CommonStackName}/verifiableCredentialKmsSigningKeyId"
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt IssueCredentialStateMachineLogGroup.Arn
        IncludeExecutionData:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            StateMachineLoggingIncludeExecutionData,
          ]
        Level:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            StateMachineLoggingLevel,
          ]
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ResultsTable
        - LambdaInvokePolicy:
            FunctionName: !Ref SSMParametersFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref DynamoUnmarshallFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref IssueCredentialFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref JwtSignerFunction
        - Statement:
            Effect: Allow
            Action: kms:Sign
            Resource: !ImportValue core-infrastructure-CriVcSigningKey1Arn
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  IssueCredentialStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/${AWS::StackName}-IssueCredential-state-machine-logs
      RetentionInDays: !Ref LogGroupRetentionInDays

  IssueCredentialStateMachineLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref IssueCredentialStateMachineLogGroup

  ####################################################################
  #                                                                  #
  # OTGTokenFunction                                           #
  #                                                                  #
  ####################################################################

  OTGTokenFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/otg-token/src/otg-token-handler.lambdaHandler
      FunctionName: !Sub "${AWS::StackName}-otgtoken"
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-otgtoken"
      Timeout: 15
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      VpcConfig:
        SecurityGroupIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-AWSServicesEndpointSecurityGroupId"
        SubnetIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdA"
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdB"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  OTGTokenFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${OTGTokenFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  OTGTokenFunctionLogGroupLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref OTGTokenFunctionLogGroup

  ####################################################################
  #                                                                  #
  # FetchQuestionsFunction                                           #
  #                                                                  #
  ####################################################################

  FetchQuestionsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/fetch-questions/src/fetch-questions-handler.lambdaHandler
      FunctionName: !Sub "${AWS::StackName}-fetchquestions"
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-fetchquestions"
          QUESTIONS_TABLE_NAME: !Ref QuestionsTable
          SQS_AUDIT_EVENT_PREFIX: !Ref AuditEventNamePrefix
          SQS_AUDIT_EVENT_QUEUE_URL:
            Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueUrl
      Timeout: 15
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      VpcConfig:
        SecurityGroupIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-AWSServicesEndpointSecurityGroupId"
        SubnetIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdA"
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdB"
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTable
        - SQSSendMessagePolicy:
            QueueName:
              Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueName
        - KMSDecryptPolicy:
            KeyId: !ImportValue core-infrastructure-CriDecryptionKey1Id
        - Statement:
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource:
              - Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueEncryptionKeyArn
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  FetchQuestionsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${FetchQuestionsFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  FetchQuestionsFunctionLogGroupLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref FetchQuestionsFunctionLogGroup

  ####################################################################
  #                                                                  #
  # SubmitAnswerFunction                                             #
  #                                                                  #
  ####################################################################

  SubmitAnswerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/submit-answer/src/submit-answer-handler.lambdaHandler
      FunctionName: !Sub "${AWS::StackName}-submit-answer"
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-submit-answer"
          PERSON_IDENTITY_TABLE_NAME: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
          RESULTS_TABLE_NAME: !Ref ResultsTable
          CI_VALUE_PARAM_NAME: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/contraIndicator"
          SQS_AUDIT_EVENT_QUEUE_URL:
            Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueUrl
      Timeout: 15
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - DynamoDBWritePolicy:
            TableName: !Ref ResultsTable
        - SQSSendMessagePolicy:
            QueueName:
              Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueName
        - KMSDecryptPolicy:
            KeyId: !ImportValue core-infrastructure-CriDecryptionKey1Id
        - Statement:
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource:
              - Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueEncryptionKeyArn
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameters
              - ssm:GetParameter
            Resource:
              - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/contraIndicator
      VpcConfig:
        SecurityGroupIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-AWSServicesEndpointSecurityGroupId"
        SubnetIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdA"
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdB"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  SubmitAnswerFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${SubmitAnswerFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  SubmitAnswerFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref SubmitAnswerFunctionLogGroup

  ####################################################################
  #                                                                  #
  # CreateAuthCodeFunction                                           #
  #                                                                  #
  ####################################################################

  CreateAuthCodeFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/submit-answer/src/create-auth-code-handler.lambdaHandler
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]

  CreateAuthCodeFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-${CreateAuthCodeFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  CreateAuthCodeFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref CreateAuthCodeFunctionLogGroup

  ####################################################################
  #                                                                  #
  # EvidenceCheckDetailsFunction                                     #
  #                                                                  #
  ####################################################################

  EvidenceCheckDetailsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/evidence-check-details/src/check-details-handler.lambdaHandler
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]

  EvidenceCheckDetailsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-${EvidenceCheckDetailsFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  EvidenceCheckDetailsFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref EvidenceCheckDetailsFunctionLogGroup

  ####################################################################
  #                                                                  #
  # Issue Credential Function                                        #
  #                                                                  #
  ####################################################################

  IssueCredentialFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/issue-credential/src/issue-credential-handler.lambdaHandler
      FunctionName: !Sub "${AWS::StackName}-issuecredential"
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-issuecredential"
          ENVIRONMENT: !Ref Environment
          RESULTS_TABLE_NAME: !Ref ResultsTable
          SQS_AUDIT_EVENT_QUEUE_URL:
            Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueUrl
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref QuestionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref QuestionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ResultsTable
        - SQSSendMessagePolicy:
            QueueName:
              Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueName
        - KMSDecryptPolicy:
            KeyId: !ImportValue core-infrastructure-CriDecryptionKey1Id
        - Statement:
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource:
              - Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueEncryptionKeyArn
      Timeout: 15
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      VpcConfig:
        SecurityGroupIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-AWSServicesEndpointSecurityGroupId"
        SubnetIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdA"
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdB"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  IssueCredentialFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${IssueCredentialFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  IssueCredentialFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref IssueCredentialFunctionLogGroup

  ####################################################################
  #                                                                  #
  # JWT Signer Function                                              #
  #                                                                  #
  ####################################################################

  JwtSignerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/jwt-signer/src/jwt-signer-handler.lambdaHandler
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      Policies:
        - Statement:
            Effect: Allow
            Action: kms:Sign
            Resource: !ImportValue core-infrastructure-CriVcSigningKey1Arn
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-JwtSigner"

  JwtSignerFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}/JwtSignerFunction
      RetentionInDays: !Ref LogGroupRetentionInDays

  JwtSignerFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref JwtSignerFunctionLogGroup

  ####################################################################
  #                                                                  #
  # Answer Validation Function                                       #
  #                                                                  #
  ####################################################################

  AnswerValidationFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/answer-validation/src/answer-validation-handler.lambdaHandler
      FunctionName: !Sub "${AWS::StackName}-answer-validation"
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]

  AnswerValidationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AnswerValidationFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  AnswerValidationFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref AnswerValidationFunctionLogGroup

  ####################################################################
  #                                                                  #
  # DynamoDB Unmarshalling Lambda                                    #
  #                                                                  #
  ####################################################################

  DynamoUnmarshallFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/dynamo-unmarshall/src/dynamo-unmarshall-handler.lambdaHandler
      FunctionName: !Sub "${AWS::StackName}-dynamo-unmarshall"
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-dynamo-unmarshall"
      Timeout: 15
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      VpcConfig:
        SecurityGroupIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-AWSServicesEndpointSecurityGroupId"
        SubnetIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdA"
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdB"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  DynamoUnmarshallFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${DynamoUnmarshallFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  DynamoUnmarshallFunctionLogGroupLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref DynamoUnmarshallFunctionLogGroup

  ####################################################################
  #                                                                  #
  # SSM Parameters cache Lambda                                       #
  #                                                                  #
  ####################################################################

  SSMParametersFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/ssm-parameters/src/ssm-parameters-handler.lambdaHandler
      FunctionName: !Sub "${AWS::StackName}-ssm-parameters"
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-ssm-parameters"
      Timeout: 15
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      VpcConfig:
        SecurityGroupIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-AWSServicesEndpointSecurityGroupId"
        SubnetIds:
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdA"
          - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdB"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameters
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/*"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${ParameterPrefix}/*"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/*"

  SSMParametersFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${SSMParametersFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  SSMParametersFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2"
      FilterPattern: ""
      LogGroupName: !Ref SSMParametersFunctionLogGroup

  ####################################################################
  #                                                                  #
  # Database Tables                                                  #
  #                                                                  #
  ####################################################################

  QuestionsTable:
    Type: "AWS::DynamoDB::Table"
    Properties:
      TableName: !Sub "questions-table-${AWS::StackName}"
      BillingMode: "PAY_PER_REQUEST"
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "sessionId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "sessionId"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: expiryDate
        Enabled: true

  AnswersTable:
    Type: "AWS::DynamoDB::Table"
    Properties:
      TableName: !Sub "answers-table-${AWS::StackName}"
      BillingMode: "PAY_PER_REQUEST"
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "sessionId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "sessionId"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: expiryDate
        Enabled: true

  ResultsTable:
    Type: "AWS::DynamoDB::Table"
    Properties:
      TableName: !Sub "results-table-${AWS::StackName}"
      BillingMode: "PAY_PER_REQUEST"
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: "sessionId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "sessionId"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: expiryDate
        Enabled: true

  ####################################################################
  #                                                                  #
  # API config                                                       #
  #                                                                  #
  ####################################################################

  PublicKbvHmrcApiUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Condition: IsDeployedFromPipeline
    Properties:
      ApiStages:
        - ApiId: !Ref PublicKbvHmrcApi
          Stage: !Ref PublicKbvHmrcApi.Stage
      Quota:
        Limit:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            apiKeythrottleQuotaLimit,
          ]
        Period: DAY
      Throttle:
        RateLimit: !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            apiKeythrottleRateLimit,
          ] # allowed requests per second
        BurstLimit: !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            apiKeythrottleBurstLimit,
          ] # requests the API can handle concurrently

  PrivateKbvHmrcApiUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Condition: IsDeployedFromPipeline
    Properties:
      ApiStages:
        - ApiId: !Ref PrivateKbvHmrcApi
          Stage: !Ref PrivateKbvHmrcApi.Stage
      Quota:
        Limit:
          !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            apiKeythrottleQuotaLimit,
          ]
        Period: DAY
      Throttle:
        RateLimit: !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            apiKeythrottleRateLimit,
          ] # allowed requests per second
        BurstLimit: !FindInMap [
            EnvironmentConfiguration,
            !Ref Environment,
            apiKeythrottleBurstLimit,
          ] # requests the API can handle concurrently
  LinkUsagePlanApiKey1:
    Condition: IsDeployedFromPipeline
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId: !ImportValue core-infrastructure-ApiKey1
      KeyType: API_KEY
      UsagePlanId: !Ref PublicKbvHmrcApiUsagePlan

  LinkUsagePlanApiKey2:
    Condition: IsDeployedFromPipeline
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId: !ImportValue core-infrastructure-ApiKey2
      KeyType: API_KEY
      UsagePlanId: !Ref PublicKbvHmrcApiUsagePlan

  ####################################################################
  #                                                                  #
  # Parameters                                                       #
  #                                                                  #
  ####################################################################

  MaxJwtTtlParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub /${AWS::StackName}/MaxJwtTtl
      Value:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          VerifiableCredentialMaxJwtTtl,
        ]
      Description: Default time to live for an JWT in (seconds)

  JwtTtlUnitParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub /${AWS::StackName}/JwtTtlUnit
      Value:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          VerifiableCredentialJwtTtlUnit,
        ]
      Description: The unit for the time-to-live for an JWT e.g. (MONTHS)

  LoggingKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"

  ####################################################################
  #                                                                  #
  # Alerts                                                           #
  #                                                                  #
  ####################################################################

  SSMParameterRequestFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - SSM Parameters Retrieval Failed Alarm"
      AlarmDescription: !Sub "${Environment} HMRC KBV Cri SSMParametersFunction failed to retrieve requested SSM Parameters"
      ActionsEnabled: false
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: []
      MetricName: CompletionStatus
      Namespace: !Ref CriIdentifier
      Statistic: Average
      Dimensions:
        - Name: service
          Value: !Sub "${CriIdentifier}-ssm-parameters"
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 3
      Threshold: 0.95
      ComparisonOperator: LessThanThreshold
      TreatMissingData: notBreaching

  OTGTokenRequestFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - OTG Token Request Failed Alarm"
      AlarmDescription: !Sub "${Environment} HMRC KBV Cri failed to retrieve a token from the OTG Service"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: FailedToRetrieveOTGToken
      Namespace: !Ref CriIdentifier
      Statistic: Sum
      Dimensions:
        - Name: service
          Value: !Sub "${CriIdentifier}-otgtoken"
        - Name: ServiceSpecific
          Value: OTGTokenRetrievalService
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  HMRCKBVLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - HMRC KBV lambda Error Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} lambda errors"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions: []
      Period: 300
      DatapointsToAlarm: 3
      EvaluationPeriods: 3
      Threshold: 2
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  HMRCKBVAPIGW5XXErrors:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - API Gateway 5XX errors Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} API Gateway 5XX errors"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      DatapointsToAlarm: 3
      EvaluationPeriods: 3
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: e1
          Label: Expression1
          ReturnData: true
          Expression: SUM(METRICS())
        - Id: m1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicKbvHmrcApi"
            Period: 300
            Stat: Sum
        - Id: m2
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateKbvHmrcApi"
            Period: 300
            Stat: Sum

  HMRCKBVAPIGW5XXErrorsPrivatePercentage:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Private API Gateway Percentage 5XX Errors Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} Private API Gateway Percentage 5XX Errors"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      DatapointsToAlarm: 3
      EvaluationPeriods: 3
      Threshold: 49
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: e1
          Label: PercentageFailure
          ReturnData: true
          Expression: (m2/m1)*100
        - Id: m1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateKbvHmrcApi"
            Period: 60
            Stat: Sum
        - Id: m2
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateKbvHmrcApi"
            Period: 60
            Stat: Sum

  AnswerValidationLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Answer Validation Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - Answer Validation Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Ref AnswerValidationFunction
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 9
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  EvidenceCheckDetailsLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Evidence Check Details Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - Evidence Check Details Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Ref EvidenceCheckDetailsFunction
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 9
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  FetchQuestionsLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Fetch Questions Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - Fetch Questions Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Ref FetchQuestionsFunction
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 9
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  IssueCredentialLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Issue Credential Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - Issue Credential Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Ref IssueCredentialFunction
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 9
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  JwtSignerLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - JWT Signer Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - JWT Signer Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Ref JwtSignerFunction
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 9
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  OtgTokenLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - OTG Token Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - OTG Token Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Ref OTGTokenFunction
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 9
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  SubmitAnswerLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Submit Answer Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - Submit Answer Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Ref SubmitAnswerFunction
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 9
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  CommonAPISessionLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Common API Session Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - Common API Session Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Sub "${CommonStackName}-SessionFunctionTS"
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 6
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  CommonAPIAuthorizationLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Common API Authorization Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - Common API Authorization Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Sub "${CommonStackName}-AuthorizationFunctionTS"
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 6
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  CommonAPIAccessTokenLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Common API AccessToken Lambda concurrency Alarm"
      AlarmDescription: !Sub "HMRC KBV ${Environment} - Common API AccessToken Lambda concurrency threshold reached"
      ActionsEnabled: false
      AlarmActions:
        - !Ref AlarmTopicHmrcKbv
      OKActions:
        - !Ref AlarmTopicHmrcKbv
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Sub "${CommonStackName}-AccessTokenFunctionTS"
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 6
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  ####################################################################
  #                                                                  #
  # Alarm setup                                                      #
  #                                                                  #
  ####################################################################

  AlarmTopicHmrcKbv:
    Type: AWS::SNS::Topic
    Metadata:
      SamResourceId: AlarmTopicHmrcKbv

  AlarmTopicSubscriptionPagerDutyHmrcKbv:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn:
        Ref: AlarmTopicHmrcKbv
      Endpoint:
        Fn::Sub: "{{resolve:ssm:/alerting/pagerduty-hmrc-kbv/url}}"
      Protocol: https
    Metadata:
      SamResourceId: AlarmTopicSubscriptionPagerDutyHmrcKbv

  AlarmPublishToTopicPolicyHmrcKbv:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - Ref: AlarmTopicHmrcKbv
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sns:Publish
            Resource:
              Ref: AlarmTopicHmrcKbv
            Principal:
              Service: cloudwatch.amazonaws.com
            Condition:
              ArnLike:
                AWS:SourceArn:
                  Fn::Sub: arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:*
    Metadata:
      SamResourceId: AlarmPublishToTopicPolicyHmrcKbv

####################################################################
#                                                                  #
# Outputs                                                          #
#                                                                  #
####################################################################

Outputs:
  PublicApiGatewayId:
    Description: API Gateway ID of the public HMRC KBV CRI API
    Value: !Ref PublicKbvHmrcApi
    Export:
      Name: !Sub ${AWS::StackName}-PublicApiGatewayId
  PrivateApiGatewayId:
    Description: API Gateway ID of the private HMRC KBV CRI API
    Value: !Ref PrivateKbvHmrcApi
    Export:
      Name: !Sub ${AWS::StackName}-PrivateApiGatewayId
  FetchQuestionsStateMachineArn:
    Description: Exported for integration test
    Value: !Ref FetchQuestionsStateMachine
  QuestionStateMachineArn:
    Description: Exported for integration test
    Value: !Ref GetQuestionStateMachine
  PostAnswerStateMachineArn:
    Description: Exported for integration test
    Value: !Ref PostAnswerStateMachine
  IssueCredentialStateMachineArn:
    Description: Exported for integration test
    Value: !Ref IssueCredentialStateMachine
  CommonAPISessionTableName:
    Description: Exported for integration test (Common API session table name)
    Value: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
  CommonAPIPersonIdentityTableName:
    Description: Exported for integration test (Common API person identity table name)
    Value: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
  QuestionsTableName:
    Description: Exported for integration test
    Value: !Ref QuestionsTable
  ResultsTableName:
    Description: Exported for integration test
    Value: !Ref ResultsTable
